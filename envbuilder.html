<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css">
    <title>Environment Builder</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
                }
            }
        };
    </script>

    <style>
        .env-grid {
            display: grid;
            grid-template-columns: repeat(7, 48px);
            grid-template-rows: repeat(7, 48px);
            gap: 6px;
        }

        .env-cell {
            width: 48px;
            height: 48px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.12s ease, box-shadow 0.12s ease, transform 0.05s ease;
            box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.06);
            user-select: none;
        }

        .env-cell:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.15);
        }

        .env-cell-empty {
            background-color: #E5E7EB;
            /* gray-200 */
            color: #6B7280;
            /* gray-500 */
        }

        .env-cell-food {
            background-color: #FDBA74;
            /* orange-300 */
            color: #7C2D12;
            /* orange-900 */
        }

        .env-cell-enemy-small {
            background-color: #A7F3D0;
            /* emerald-200 */
            color: #064E3B;
            /* emerald-900 */
        }

        .env-cell-enemy-big {
            background-color: #FCA5A5;
            /* red-300 */
            color: #7F1D1D;
            /* red-900 */
        }

        .env-cell-center {
            background-color: #DBEAFE;
            /* blue-100 */
            color: #1D4ED8;
            /* blue-700 */
            cursor: not-allowed;
        }

        .badge {
            @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium cursor-pointer;
        }

        .badge-gray {
            background-color: #E5E7EB;
            /* gray-200 */
            color: #374151;
            /* gray-700 */
        }

        .badge-gray:hover {
            background-color: #D1D5DB;
            /* gray-300 */
        }

        .palette-item {
            border-radius: 0.75rem;
            border: 1px solid #E5E7EB;
            background-color: #F9FAFB;
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: grab;
            transition: box-shadow 0.12s ease, transform 0.05s ease, background-color 0.12s ease;
        }

        .palette-item:hover {
            background-color: #FFFFFF;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.12);
        }

        .palette-symbol {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .palette-symbol-food {
            background-color: #FDBA74;
            color: #7C2D12;
        }

        .palette-symbol-enemy-small {
            background-color: #A7F3D0;
            color: #064E3B;
        }

        .palette-symbol-enemy-big {
            background-color: #FCA5A5;
            color: #7F1D1D;
        }

        .palette-symbol-empty {
            background-color: #E5E7EB;
            color: #6B7280;
        }

        .pill-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen p-4 sm:p-8 font-sans">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex items-center justify-between mb-6 pb-4 border-b border-gray-300">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Environment Builder</h1>
                <p class="text-sm text-gray-500 mt-1">Baue einen Env-String für den Pybiester Game-Analyzer.</p>
            </div>
            <a href="index.html"
                class="inline-flex items-center px-3 py-2 rounded-lg bg-white border border-gray-300 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-50">
                Zurück
            </a>
        </header>
        <!-- Tabs / Navigation -->
        <nav class="bg-white rounded-xl shadow-sm p-2 flex items-center justify-center space-x-4">
            <a href="index.html" class="nav-tab">Biester Dashboard</a>
            <a href="index.html" class="nav-tab">World Dashboard</a>
            <a href="envbuilder.html" class="nav-tab active">Environment Builder</a>
        </nav>

        <!-- Box: fertiger String + Copy -->
        <section class="mb-6 mt-6">
            <div
                class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 sm:p-5 flex flex-col sm:flex-row gap-3 items-stretch sm:items-center">
                <div class="flex-1">
                    <label for="envStringOutput" class="block text-xs font-semibold text-gray-500 mb-1">
                        Aktueller id_energy_env String
                    </label>
                    <input id="envStringOutput" type="text" readonly
                        class="w-full text-xs sm:text-sm font-mono px-3 py-2 rounded-lg border border-gray-300 bg-gray-50 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value="id_energy_env = '# #...............................................'">
                </div>
                <div class="flex sm:flex-col justify-center sm:justify-between gap-2">
                    <button id="copyButton"
                        class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-sm font-semibold text-white shadow-sm">
                        Env String kopieren
                    </button>
                </div>
            </div>
        </section>

        <!-- Eingaben + Grid + Palette -->
        <main class="grid grid-cols-1 lg:grid-cols-[minmax(0,2fr)_minmax(0,3fr)_minmax(0,2fr)] gap-6">
            <!-- Linke Spalte: Beast ID & Energie -->
            <section class="space-y-6">
                <!-- Beast ID -->
                <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 sm:p-5">
                    <h2 class="text-lg font-semibold text-gray-800 mb-3">Beast ID</h2>
                    <label for="idInput" class="block text-xs font-semibold text-gray-500 mb-1">
                        Beast ID
                    </label>
                    <input id="idInput" type="text" placeholder="z.B. 18"
                        class="w-full px-3 py-2 rounded-lg border border-gray-300 bg-gray-50 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3" />

                    <div class="mb-2 flex items-center justify-between">
                        <span class="pill-label text-gray-500">Verlauf Beast IDs</span>
                        <button id="clearIdHistory" type="button" class="text-xs text-gray-400 hover:text-gray-600">
                            Verlauf löschen
                        </button>
                    </div>
                    <div id="idHistoryContainer" class="flex flex-wrap gap-2 text-xs">
                        <!-- History-Badges -->
                    </div>
                </div>

                <!-- Energie -->
                <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 sm:p-5">
                    <h2 class="text-lg font-semibold text-gray-800 mb-3">Energie</h2>
                    <label for="energyInput" class="block text-xs font-semibold text-gray-500 mb-1">
                        Energie (Kommazahl mit Punkt)
                    </label>
                    <input id="energyInput" type="number" step="0.0000000001" placeholder="z.B. 12.76393202250021"
                        class="w-full px-3 py-2 rounded-lg border border-gray-300 bg-gray-50 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3" />

                    <div class="mb-2 flex items-center justify-between">
                        <span class="pill-label text-gray-500">Verlauf Energien</span>
                        <button id="clearEnergyHistory" type="button" class="text-xs text-gray-400 hover:text-gray-600">
                            Verlauf löschen
                        </button>
                    </div>
                    <div id="energyHistoryContainer" class="flex flex-wrap gap-2 text-xs mb-3">
                        <!-- History-Badges -->
                    </div>

                    <div class="mb-2">
                        <span class="pill-label text-gray-500">Vorschläge</span>
                    </div>
                    <div id="energySuggestions" class="flex flex-wrap gap-2 text-xs">
                        <!-- Vorschlag-Badges -->
                    </div>
                </div>
            </section>

            <!-- Mitte: Grid -->
            <section class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 sm:p-5 flex flex-col items-center">
                <h2 class="text-lg font-semibold text-gray-800 mb-3 self-start">7x7 Spielfeld</h2>
                <p class="text-xs text-gray-500 mb-4 self-start">
                    Ziehe Objekte von rechts auf das Spielfeld. Die mittlere Kachel (blau) bleibt immer leer.
                </p>
                <div class="flex-1 flex items-center justify-center">
                    <div id="envGrid" class="env-grid"></div>
                </div>
                <p class="mt-4 text-xs text-gray-400 text-center">
                    Mapping: Index 0 = oben links, Index 48 = unten rechts. Mitte (Index 24) ist fix und bleibt <code
                        class="font-mono">.</code>.
                </p>
            </section>

            <!-- Rechte Spalte: Palette -->
            <section class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 sm:p-5">
                <h2 class="text-lg font-semibold text-gray-800 mb-3">Objekt-Palette</h2>
                <p class="text-xs text-gray-500 mb-4">
                    Diese Objekte kannst du per Drag &amp; Drop auf das Spielfeld ziehen. Pro Kachel ist immer genau ein
                    Objekt erlaubt.
                </p>

                <div class="space-y-3">
                    <div class="palette-item" draggable="true" data-char="*">
                        <div>
                            <div class="text-sm font-semibold text-gray-800">Futter</div>
                            <div class="text-xs text-gray-500">Symbol: <code class="font-mono">*</code></div>
                        </div>
                        <div class="palette-symbol palette-symbol-food">*</div>
                    </div>

                    <div class="palette-item" draggable="true" data-char="<">
                        <div>
                            <div class="text-sm font-semibold text-gray-800">Kleiner Gegner</div>
                            <div class="text-xs text-gray-500">Symbol: <code class="font-mono">&lt;</code></div>
                        </div>
                        <div class="palette-symbol palette-symbol-enemy-small">&lt;</div>
                    </div>

                    <div class="palette-item" draggable="true" data-char=">">
                        <div>
                            <div class="text-sm font-semibold text-gray-800">Großer Gegner</div>
                            <div class="text-xs text-gray-500">Symbol: <code class="font-mono">&gt;</code></div>
                        </div>
                        <div class="palette-symbol palette-symbol-enemy-big">&gt;</div>
                    </div>

                    <div class="palette-item" draggable="true" data-char=".">
                        <div>
                            <div class="text-sm font-semibold text-gray-800">Leeres Feld</div>
                            <div class="text-xs text-gray-500">Symbol: <code class="font-mono">.</code></div>
                        </div>
                        <div class="palette-symbol palette-symbol-empty">.</div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-200 text-xs text-gray-500">
                    Tipp: Du kannst jederzeit Beast ID oder Energie ändern – der Env String aktualisiert sich
                    automatisch.
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GRID_SIZE = 7;
            const ENV_LENGTH = GRID_SIZE * GRID_SIZE;
            const CENTER_INDEX = 24; // 0-basiert, Mitte von 7x7

            const envGrid = document.getElementById('envGrid');
            const envStringOutput = document.getElementById('envStringOutput');
            const copyButton = document.getElementById('copyButton');

            const idInput = document.getElementById('idInput');
            const idHistoryContainer = document.getElementById('idHistoryContainer');
            const clearIdHistoryBtn = document.getElementById('clearIdHistory');

            const energyInput = document.getElementById('energyInput');
            const energyHistoryContainer = document.getElementById('energyHistoryContainer');
            const clearEnergyHistoryBtn = document.getElementById('clearEnergyHistory');
            const energySuggestionsContainer = document.getElementById('energySuggestions');

            // State
            const envChars = Array(ENV_LENGTH).fill('.');
            let idHistory = [];
            let energyHistory = [];

            const ENERGY_SUGGESTIONS = ['1.0', '5.0', '10.0', '12.0', '12.5', '12.7639'];
            const MAX_HISTORY = 8;

            // --- Helper: Env String neu aufbauen ---
            function updateFinalString() {
                const bid = (idInput.value || '').trim();
                const energy = (energyInput.value || '').trim();
                const env = envChars.join('');

                envStringOutput.value = `id_energy_env = '${bid}#${energy}#${env}'`;
            }

            // --- Helper: History-Listen ---
            function addToHistory(list, value) {
                const v = (value || '').trim();
                if (!v) return list;

                // Wenn Wert bereits vorne steht, nichts tun
                if (list[0] === v) return list;

                // vorhandenes V entfernen und vorne einfügen
                const filtered = list.filter(x => x !== v);
                filtered.unshift(v);
                if (filtered.length > MAX_HISTORY) filtered.length = MAX_HISTORY;
                return filtered;
            }

            function renderIdHistory() {
                idHistoryContainer.innerHTML = '';
                if (!idHistory.length) {
                    const span = document.createElement('span');
                    span.className = 'text-xs text-gray-400';
                    span.textContent = 'Noch keine Einträge.';
                    idHistoryContainer.appendChild(span);
                    return;
                }

                idHistory.forEach(val => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'badge badge-gray';
                    btn.textContent = val;
                    btn.addEventListener('click', () => {
                        idInput.value = val;
                        updateFinalString();
                    });
                    idHistoryContainer.appendChild(btn);
                });
            }

            function renderEnergyHistory() {
                energyHistoryContainer.innerHTML = '';
                if (!energyHistory.length) {
                    const span = document.createElement('span');
                    span.className = 'text-xs text-gray-400';
                    span.textContent = 'Noch keine Einträge.';
                    energyHistoryContainer.appendChild(span);
                    return;
                }

                energyHistory.forEach(val => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'badge badge-gray';
                    btn.textContent = val;
                    btn.addEventListener('click', () => {
                        energyInput.value = val;
                        updateFinalString();
                    });
                    energyHistoryContainer.appendChild(btn);
                });
            }

            function renderEnergySuggestions() {
                energySuggestionsContainer.innerHTML = '';
                ENERGY_SUGGESTIONS.forEach(val => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'badge badge-gray';
                    btn.textContent = val;
                    btn.addEventListener('click', () => {
                        energyInput.value = val;
                        updateFinalString();
                    });
                    energySuggestionsContainer.appendChild(btn);
                });
            }

            // --- Helper: Zellen-Styles ---
            function resetCellClasses(cell) {
                cell.classList.remove(
                    'env-cell-empty',
                    'env-cell-food',
                    'env-cell-enemy-small',
                    'env-cell-enemy-big',
                    'env-cell-center'
                );
            }

            function updateCellAppearance(cell, char, isCenter) {
                resetCellClasses(cell);

                if (isCenter) {
                    cell.classList.add('env-cell-center');
                    cell.textContent = '';
                    return;
                }

                switch (char) {
                    case '*':
                        cell.classList.add('env-cell-food');
                        cell.textContent = '*';
                        break;
                    case '<':
                        cell.classList.add('env-cell-enemy-small');
                        cell.textContent = '<';
                        break;
                    case '>':
                        cell.classList.add('env-cell-enemy-big');
                        cell.textContent = '>';
                        break;
                    default:
                        cell.classList.add('env-cell-empty');
                        cell.textContent = '.';
                        break;
                }
            }

            // --- Grid erzeugen ---
            function buildGrid() {
                envGrid.innerHTML = '';
                for (let i = 0; i < ENV_LENGTH; i++) {
                    const cell = document.createElement('div');
                    const isCenter = (i === CENTER_INDEX);
                    cell.className = 'env-cell';
                    cell.dataset.index = String(i);

                    updateCellAppearance(cell, envChars[i], isCenter);

                    // Drag & Drop
                    cell.addEventListener('dragover', (e) => {
                        // Mittlere Zelle akzeptiert keine Drops
                        if (isCenter) return;
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'copy';
                    });

                    cell.addEventListener('drop', (e) => {
                        if (isCenter) return;
                        e.preventDefault();
                        const char = e.dataTransfer.getData('text/plain') || '.';
                        if (!['.', '*', '<', '>'].includes(char)) return;

                        const idx = parseInt(cell.dataset.index, 10);
                        if (Number.isNaN(idx)) return;

                        envChars[idx] = char;
                        updateCellAppearance(cell, char, false);
                        updateFinalString();
                    });

                    envGrid.appendChild(cell);
                }
            }

            // --- Palette Drag-Quellen ---
            function initPalette() {
                const paletteItems = document.querySelectorAll('.palette-item');
                paletteItems.forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        const char = item.getAttribute('data-char') || '.';
                        e.dataTransfer.effectAllowed = 'copy';
                        e.dataTransfer.setData('text/plain', char);
                    });
                });
            }

            // --- Copy-Funktion ---
            function copyEnvString() {
                const text = envStringOutput.value || '';
                if (!text) return;

                const originalText = copyButton.textContent;

                function setCopiedLabel() {
                    copyButton.textContent = 'Kopiert!';
                    setTimeout(() => {
                        copyButton.textContent = originalText;
                    }, 1200);
                }

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(() => {
                        setCopiedLabel();
                    }).catch(() => {
                        fallbackCopy(text, setCopiedLabel);
                    });
                } else {
                    fallbackCopy(text, setCopiedLabel);
                }
            }

            function fallbackCopy(text, onSuccess) {
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                try {
                    document.execCommand('copy');
                    if (typeof onSuccess === 'function') onSuccess();
                } catch (err) {
                    console.error('Kopieren fehlgeschlagen:', err);
                }
                document.body.removeChild(ta);
            }

            // --- Events Inputs ---
            idInput.addEventListener('input', () => {
                updateFinalString();
            });

            idInput.addEventListener('change', () => {
                idHistory = addToHistory(idHistory, idInput.value);
                renderIdHistory();
            });

            energyInput.addEventListener('input', () => {
                updateFinalString();
            });

            energyInput.addEventListener('change', () => {
                energyHistory = addToHistory(energyHistory, energyInput.value);
                renderEnergyHistory();
            });

            clearIdHistoryBtn.addEventListener('click', () => {
                idHistory = [];
                renderIdHistory();
            });

            clearEnergyHistoryBtn.addEventListener('click', () => {
                energyHistory = [];
                renderEnergyHistory();
            });

            copyButton.addEventListener('click', copyEnvString);

            // --- Initialisierung ---
            buildGrid();
            initPalette();
            renderIdHistory();
            renderEnergyHistory();
            renderEnergySuggestions();
            updateFinalString();
        });
    </script>
</body>

</html>
